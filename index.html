<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Invitación Bowling – Generador HD</title>
<style>
  :root{
    --maxw: 520px;
    --ui-bg: #0b0b12;
    --accent:#7c3aed;
  }
  html,body{
    margin:0;height:100%;background:var(--ui-bg);color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
  }
  .wrap{max-width:var(--maxw);margin:0 auto;padding:14px 14px 120px}
  h2{margin:16px 0 10px;font-size:18px}
  .card{width:100%;position:relative}
  canvas{width:100%;height:auto;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.5);background:#000}
  .panel{display:grid;gap:10px;margin:8px 0 16px}
  .row{display:grid;grid-template-columns:1fr;gap:6px}
  label{font-size:12px;opacity:.85}
  input[type="text"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
    background:#1b1b25;color:#fff;font-weight:600;outline:none;
  }
  details{background:#12121a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px}
  details summary{cursor:pointer;font-weight:700}
  .ctrls{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
  .ctrls button{padding:8px 6px;border:none;border-radius:8px;background:#2a2a35;color:#fff;cursor:pointer}
  .ctrls small{grid-column:1/-1;opacity:.7}
  .toolbar{position:fixed;left:0;right:0;bottom:0;background:rgba(12,12,18,.88);backdrop-filter:blur(6px);
    border-top:1px solid rgba(255,255,255,.08);padding:10px 12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  button.main{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--accent);color:#fff;
    box-shadow:0 6px 20px rgba(124,58,237,.35)}
  button.secondary{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#2a2a35;color:#fff}
  .note{font-size:12px;opacity:.75;text-align:center;margin:8px auto 0;max-width:520px}
</style>
</head>
<body>
  <div class="wrap">

    <!-- PASO 1 -->
    <h2>Paso 1 · Rellena tu información</h2>
    <div class="panel">
      <div class="row">
        <label for="soy">SOY</label>
        <input id="soy" type="text" placeholder="Tu nombre"/>
      </div>
      <div class="row">
        <label for="nombre">NOMBRE (invitado)</label>
        <input id="nombre" type="text" placeholder="Nombre del invitado"/>
      </div>
      <div class="row">
        <label for="dia">EL DÍA</label>
        <input id="dia" type="text" placeholder="DD/MM/AAAA"/>
      </div>
      <div class="row">
        <label for="hora">HORA</label>
        <input id="hora" type="text" placeholder="Ej: 4:00 p. m."/>
      </div>
      <div class="row">
        <label for="confirma">CONFIRMA AL</label>
        <input id="confirma" type="text" placeholder="Teléfono o Email"/>
      </div>

      <!-- Ajuste fino opcional (guardado en el navegador) -->
      <details>
        <summary>⚙️ Ajustar posiciones (opcional)</summary>
        <div class="ctrls" id="ctrls"></div>
        <small>Tip: ajustes de 0.2% ≈ 5–6 px. Los cambios se guardan (puedes restablecer al final).</small>
      </details>
    </div>

    <!-- PASO 2 -->
    <h2>Paso 2 · Previsualiza y descarga</h2>
    <div class="card">
      <canvas id="cv" width="1080" height="2800"></canvas>
    </div>

  </div>

  <p class="note">La descarga es HD (3×). Si cambias de móvil, puedes reajustar con los controles.</p>

  <div class="toolbar">
    <button id="btnPng" class="main">Descargar PNG</button>
    <button id="btnPdf" class="secondary">Descargar PDF</button>
    <button id="btnShare" class="secondary">Compartir</button>
    <button id="btnReset" class="secondary">Restablecer posiciones</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
/* ===== CONFIGURACIÓN ===== */
const BASE_W = 1080, BASE_H = 2800;
const SCALE   = 3;        // export retina 3×
const TEXT_SCALE = 0.94;  // ↓ “un punto” aprox. frente a lo anterior

// Cajas en % (centradas en tus pastillas blancas del PNG)
const defaults = {
  soy:      {x:0.10,y:0.437,w:0.80,h:0.047},
  nombre:   {x:0.14,y:0.606,w:0.72,h:0.049},
  dia:      {x:0.14,y:0.674,w:0.72,h:0.048},
  hora:     {x:0.14,y:0.740,w:0.72,h:0.049},   // ahora un único campo
  confirma: {x:0.14,y:0.811,w:0.72,h:0.050}
};

const pos = load('inv_bowling_pos') || structuredClone(defaults);

const cv = document.getElementById('cv');
cv.width  = BASE_W * SCALE;
cv.height = BASE_H * SCALE;
const ctx = cv.getContext('2d');

const bg = new Image();
bg.onload = () => draw();
bg.src = 'bg.png';

/* ===== UI ajuste fino ===== */
const fields = ['soy','nombre','dia','hora','confirma'];
const ctrls = document.getElementById('ctrls');
buildCtrls();

document.getElementById('btnReset').onclick = ()=>{
  save('inv_bowling_pos', null);
  Object.assign(pos, structuredClone(defaults));
  draw(); buildCtrls();
};

function buildCtrls(){
  ctrls.innerHTML='';
  const delta = 0.002; // 0.2%
  fields.forEach(key=>{
    const wrap = document.createElement('div');
    wrap.style.gridColumn = '1 / -1';
    const title = document.createElement('div');
    title.style.margin='6px 0 4px'; title.style.fontWeight='700';
    title.textContent = `• ${key.toUpperCase()}`;
    wrap.appendChild(title);

    const grid = document.createElement('div'); grid.className='ctrls';
    function b(t, cb){ const x=document.createElement('button'); x.textContent=t; x.onclick=()=>{cb();save('inv_bowling_pos',pos);draw();}; return x; }
    grid.append(
      b('←', ()=> pos[key].x = clamp01(pos[key].x - delta)),
      b('→', ()=> pos[key].x = clamp01(pos[key].x + delta)),
      b('↑', ()=> pos[key].y = clamp01(pos[key].y - delta)),
      b('↓', ()=> pos[key].y = clamp01(pos[key].y + delta)),
      b('− ancho', ()=> pos[key].w = clamp01(pos[key].w - delta)),
      b('+ ancho', ()=> pos[key].w = clamp01(pos[key].w + delta)),
    );
    const hint = document.createElement('small');
    hint.textContent='Ajuste fino: 0.2% ≈ 5–6 px';
    grid.append(hint);
    wrap.appendChild(grid);
    ctrls.appendChild(wrap);
  });
}

/* ===== DIBUJO ===== */
function boxPx(b){
  return {
    x: Math.round(b.x * BASE_W * SCALE),
    y: Math.round(b.y * BASE_H * SCALE),
    w: Math.round(b.w * BASE_W * SCALE),
    h: Math.round(b.h * BASE_H * SCALE)
  };
}
function fit(text, maxW, maxPx, minPx){
  let s = maxPx;
  while(s > minPx){
    ctx.font = `bold ${s}px Arial, Helvetica, sans-serif`;
    if (ctx.measureText(text).width <= maxW * 0.92) break;
    s -= 1;
  }
  return s;
}
function drawCentered(b, val, placeholder, maxFs=66, minFs=30){ // ↓ tamaños base
  const B = boxPx(b);
  const t = (val||'').trim();
  const show = t || placeholder;
  const color = t ? '#000' : '#777';
  const fs = Math.round(fit(show, B.w, maxFs*SCALE*TEXT_SCALE, minFs*SCALE*TEXT_SCALE));
  ctx.font = `bold ${fs}px Arial, Helvetica, sans-serif`;
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(show, B.x + B.w/2, B.y + B.h/2);
}

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.drawImage(bg, 0, 0, cv.width, cv.height);

  const v = id => document.getElementById(id).value;

  drawCentered(pos.soy, v('soy'), 'Escribe tu nombre');
  drawCentered(pos.nombre, v('nombre'), 'Nombre del invitado');
  drawCentered(pos.dia, v('dia'), 'DD/MM/AAAA');
  drawCentered(pos.hora, v('hora'), 'HH:MM');           // un solo campo hora
  drawCentered(pos.confirma, v('confirma'), 'Teléfono o Email');

  save('inv_bowling_last', {soy:v('soy'),nombre:v('nombre'),dia:v('dia'),hora:v('hora'),confirma:v('confirma')});
}

/* ===== EXPORTAR ===== */
document.getElementById('btnPng').onclick = ()=>{
  const a = document.createElement('a');
  a.download = `invitacion-bowling-${Date.now()}.png`;
  a.href = cv.toDataURL('image/png');
  a.click();
};
document.getElementById('btnPdf').onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'px', format:[BASE_W*SCALE, BASE_H*SCALE]});
  doc.addImage(cv.toDataURL('image/jpeg', 0.98), 'JPEG', 0, 0, BASE_W*SCALE, BASE_H*SCALE);
  doc.save(`invitacion-bowling-${Date.now()}.pdf`);
};
document.getElementById('btnShare').onclick = async()=>{
  try{
    const blob = await (await fetch(cv.toDataURL('image/png'))).blob();
    const file = new File([blob], `invitacion-bowling.png`, { type:'image/png' });
    if(navigator.canShare && navigator.canShare({ files:[file] })){
      await navigator.share({ files:[file], title:'Invitación Bowling', text:'Te comparto la invitación ✨' });
    }else{
      alert('Si tu móvil no permite compartir, usa “Descargar PNG”.');
    }
  }catch(e){ alert('No se pudo abrir la hoja de compartir. Usa “Descargar PNG”.'); }
};

/* ===== PERSISTENCIA ===== */
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function save(k, v){ if(v===null){ localStorage.removeItem(k); } else { localStorage.setItem(k, JSON.stringify(v)); } }
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(_){ return null; } }

/* Restaurar últimos textos */
(function restore(){
  const last = load('inv_bowling_last'); if(!last) return;
  Object.entries(last).forEach(([k,val])=>{ const el=document.getElementById(k); if(el) el.value=val; });
})();

/* Eventos → redibuja */
['soy','nombre','dia','hora','confirma'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', draw);
  el.addEventListener('change', draw);
});

/* primer render */
draw();
</script>
</body>
</html>
